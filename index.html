<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Gotham', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 400;
            background: linear-gradient(135deg, #3d5BA6 0%, #98c5ed 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(61, 91, 166, 0.2);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #3d5BA6;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-family: 'Permanent Marker', cursive;
            text-shadow: 2px 2px 4px rgba(61, 91, 166, 0.3);
        }

        .upload-section {
            background: #f7fafc;
            border: 3px dashed #98c5ed;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #3d5BA6;
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(61, 91, 166, 0.15);
        }

        .upload-section.dragover {
            border-color: #FDC503;
            background: #fffef0;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #3d5BA6;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .upload-hint {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-weight: 500;
            color: #3d5BA6;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #98c5ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            color: #3d5BA6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        select:focus {
            outline: none;
            border-color: #FDC503;
            box-shadow: 0 0 0 3px rgba(253, 197, 3, 0.2);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(61, 91, 166, 0.1);
            transition: transform 0.3s ease;
            border: 2px solid #98c5ed;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            border-color: #FDC503;
            box-shadow: 0 15px 35px rgba(61, 91, 166, 0.15);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 500;
            color: #3d5BA6;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #98c5ed;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .stats-summary {
            background: linear-gradient(135deg, #3d5BA6, #98c5ed);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
            box-shadow: 0 8px 25px rgba(61, 91, 166, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #FDC503;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #3d5BA6;
            display: none;
            font-weight: 500;
        }

        .error {
            background: rgba(210, 10, 3, 0.1);
            color: #d20A03;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid rgba(210, 10, 3, 0.3);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Call Analytics Dashboard</h1>
        
        <div class="upload-section" onclick="document.getElementById('fileInput').click()">
            <div class="upload-text">ðŸ“‚ Click to upload CSV file or drag & drop</div>
            <div class="upload-hint">Expected format: CSV with "Call notes" column containing call user and result information</div>
            <input type="file" id="fileInput" accept=".csv" />
        </div>

        <div class="error" id="errorMessage"></div>
        <div class="loading" id="loading">Processing your data...</div>

        <div class="filters" id="filters" style="display: none;">
            <label>
                <strong>View Type:</strong>
                <select id="viewType">
                    <option value="individual">Individual Callers</option>
                    <option value="comparison">Compare All Callers</option>
                </select>
            </label>
            
            <label>
                <strong>Metric:</strong>
                <select id="metricType">
                    <option value="calls">Total Calls</option>
                    <option value="success">Successful Calls</option>
                    <option value="declines">Declined Calls</option>
                    <option value="rate">Success Rate %</option>
                </select>
            </label>
        </div>

        <div class="stats-summary" id="statsSummary">
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="charts-grid" id="chartsContainer"></div>
    </div>

    <script>
        let csvData = [];
        let processedData = {};
        let charts = {};

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.querySelector('.upload-section');
        const errorDiv = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');

        fileInput.addEventListener('change', handleFile);

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        showError('Please upload a CSV file.');
        return;
    }

    showLoading(true);
    hideError();

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: true,
        delimiter: "", // Let PapaParse auto-detect the delimiter
        complete: function(results) {
            if (results.errors.length > 0) {
                showError('Error parsing CSV: ' + results.errors.map(e => e.message).join('; '));
                showLoading(false);
                return;
            }
            if (!results.meta.fields || !results.meta.fields.some(field => field.toLowerCase().trim().includes('call notes'))) {
                showError('CSV must contain a "Call notes" column.');
                showLoading(false);
                return;
            }
            csvData = results.data;
            processData();
            showLoading(false);
        },
        error: function(error) {
            showError('Error reading file: ' + error.message);
            showLoading(false);
        }
    });
}
                    
                    csvData = results.data;
                    processData();
                    showLoading(false);
                },
                error: function(error) {
                    showError('Error reading file: ' + error.message);
                    showLoading(false);
                }
            });
        }

        function processData() {
            if (csvData.length === 0) {
                showError('No data found in CSV file.');
                return;
            }

            // Find the call notes column
            const headers = Object.keys(csvData[0]);
            let callNotesColumn = null;
            
            for (const header of headers) {
                const lowerHeader = header.toLowerCase().trim();
                if (lowerHeader.includes('call notes') || lowerHeader.includes('notes') || lowerHeader.includes('call')) {
                    callNotesColumn = header;
                    break;
                }
            }

            if (!callNotesColumn) {
                showError('Could not find call notes column. Please ensure your CSV has a column containing call information.');
                return;
            }

            // Process the data by parsing call notes
            processedData = {};
            let totalProcessed = 0;
            let errorCount = 0;
            
            csvData.forEach((row, index) => {
                const callNotes = row[callNotesColumn]?.toString();
                if (!callNotes) return;

                try {
                    // Split call notes by 'Dialfire call result' to handle multiple entries
                    const callEntries = callNotes.split(/(?=Dialfire call result:)/i);
                    
                    for (const entry of callEntries) {
                        // Extract call user - pattern: "Call user: USERNAME"
                        const userMatch = entry.match(/Call user:\s*([^$\n]+?)(?:\$|Call comment|$)/i);
                        if (!userMatch) continue;
                        
                        let caller = userMatch[1].trim();
                        
                        // Clean up the caller name - remove @clienthub and similar suffixes
                        caller = caller.replace(/@.*$/, '').replace(/\$.*$/, '').trim();
                        
                        // Extract call result - pattern: "Dialfire call result: RESULT"
                        const resultMatch = entry.match(/Dialfire call result:\s*([^\/\$\n]+)/i);
                        if (!resultMatch) continue;
                        
                        const result = resultMatch[1].trim().toLowerCase();
                        
                        // Try to extract date/period
                        let period = 'Current Period';
                        const dateMatch = entry.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})|(\w+\s+\d{4})/);
                        if (dateMatch) {
                            period = dateMatch[0];
                        }

                        if (!caller || !result) continue;

                        // Initialize caller data structure
                        if (!processedData[caller]) {
                            processedData[caller] = {};
                        }

                        if (!processedData[caller][period]) {
                            processedData[caller][period] = {
                                calls: 0,
                                success: 0,
                                declines: 0
                            };
                        }

                        // Count the call
                        processedData[caller][period].calls += 1;
                        
                        // Categorize the result
                        if (result.includes('success') || result.includes('answered') || result.includes('connected')) {
                            processedData[caller][period].success += 1;
                        } else if (result.includes('declined') || result.includes('busy') || result.includes('no answer') || result.includes('failed')) {
                            processedData[caller][period].declines += 1;
                        } else {
                            // For unknown results, categorize as declined
                            processedData[caller][period].declines += 1;
                        }
                        
                        totalProcessed++;
                    }
                } catch (error) {
                    errorCount++;
                    console.warn(`Error processing row ${index + 1}:`, error);
                }
            });

            if (Object.keys(processedData).length === 0 || totalProcessed === 0) {
                showError(`No valid call data found. Processed ${totalProcessed} calls with ${errorCount} errors. Please check that your call notes contain "Call user:" and "Dialfire call result:" patterns.`);
                return;
            }

            console.log(`Successfully processed ${totalProcessed} calls for ${Object.keys(processedData).length} callers.`);
            if (errorCount > 0) {
                console.warn(`${errorCount} rows had parsing errors.`);
            }

            // Show filters and create initial charts
            document.getElementById('filters').style.display = 'flex';
            document.getElementById('statsSummary').style.display = 'block';
            
            updateStats();
            createCharts();

            // Add event listeners for filters
            document.getElementById('viewType').addEventListener('change', createCharts);
            document.getElementById('metricType').addEventListener('change', createCharts);
        }

        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const totalCallers = Object.keys(processedData).length;
            
            let totalCalls = 0, totalSuccess = 0, totalDeclines = 0;
            
            Object.values(processedData).forEach(callerData => {
                Object.values(callerData).forEach(period => {
                    totalCalls += period.calls;
                    totalSuccess += period.success;
                    totalDeclines += period.declines;
                });
            });

            const successRate = totalCalls > 0 ? ((totalSuccess / totalCalls * 100).toFixed(1)) : 0;

            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${totalCallers}</div>
                    <div class="stat-label">Total Callers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalCalls.toLocaleString()}</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                </div class="stat-item">
                    <div class="stat-value">${totalSuccess.toLocaleString()}</div>
                    <div class="stat-label">Successful</div>
                </div>
                </div class="stat-item">
                    <div class="stat-value">${successRate}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            `;
        }

        function createCharts() {
            const container = document.getElementById('chartsContainer');
            const viewType = document.getElementById('viewType').value;
            const metricType = document.getElementById('metricType').value;

            // Clear existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            container.innerHTML = '';

            if (viewType === 'individual') {
                createIndividualCharts(metricType);
            } else {
                createComparisonChart(metricType);
            }
        }

        function createIndividualCharts(metricType) {
            const container = document.getElementById('chartsContainer');

            Object.entries(processedData).forEach(([caller, periods]) => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                
                const canvas = document.createElement('canvas');
                const chartId = `chart-${caller.replace(/\s+/g, '-')}`;
                canvas.id = chartId;

                chartDiv.innerHTML = `
                    <div class="chart-title">${caller}</div>
                    <div class="chart-wrapper"></div>
                `;
                
                chartDiv.querySelector('.chart-wrapper').appendChild(canvas);
                container.appendChild(chartDiv);

                const periodsSorted = Object.keys(periods).sort();
                const data = periodsSorted.map(period => {
                    const p = periods[period];
                    switch(metricType) {
                        case 'calls': return p.calls;
                        case 'success': return p.success;
                        case 'declines': return p.declines;
                        case 'rate': return p.calls > 0 ? (p.success / p.calls * 100) : 0;
                        default: return p.calls;
                    }
                });

                const ctx = canvas.getContext('2d');
                charts[chartId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: periodsSorted,
                        datasets: [{
                            label: getMetricLabel(metricType),
                            data: data,
                            borderColor: '#3d5BA6',
                            backgroundColor: 'rgba(61, 91, 166, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#FDC503',
                            pointBorderColor: '#3d5BA6',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(152, 197, 237, 0.3)'
                                },
                                ticks: {
                                    color: '#3d5BA6'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(152, 197, 237, 0.3)'
                                },
                                ticks: {
                                    color: '#3d5BA6'
                                }
                            }
                        }
                    }
                });
            });
        }

        function createComparisonChart(metricType) {
            const container = document.getElementById('chartsContainer');
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.style.gridColumn = '1 / -1'; // Full width
            
            const canvas = document.createElement('canvas');
            const chartId = 'comparison-chart';
            canvas.id = chartId;

            chartDiv.innerHTML = `
                <div class="chart-title">All Callers Comparison - ${getMetricLabel(metricType)}</div>
                <div class="chart-wrapper"></div>
            `;
            
            chartDiv.querySelector('.chart-wrapper').appendChild(canvas);
            container.appendChild(chartDiv);

            // Get all unique periods
            const allPeriods = new Set();
            Object.values(processedData).forEach(periods => {
                Object.keys(periods).forEach(period => allPeriods.add(period));
            });
            const sortedPeriods = Array.from(allPeriods).sort();

            // Create datasets for each caller
            const datasets = Object.entries(processedData).map(([caller, periods], index) => {
                const colors = [
                    '#3d5BA6', '#FDC503', '#98c5ed', '#d20A03',
                    '#3d5BA6', '#FDC503', '#98c5ed', '#d20A03',
                    '#3d5BA6', '#FDC503', '#98c5ed', '#d20A03'
                ];
                
                const color = colors[index % colors.length];
                
                const data = sortedPeriods.map(period => {
                    const p = periods[period];
                    if (!p) return null;
                    
                    switch(metricType) {
                        case 'calls': return p.calls;
                        case 'success': return p.success;
                        case 'declines': return p.declines;
                        case 'rate': return p.calls > 0 ? (p.success / p.calls * 100) : 0;
                        default: return p.calls;
                    }
                });

                return {
                    label: caller,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                };
            });

            const ctx = canvas.getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedPeriods,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(152, 197, 237, 0.3)'
                            },
                            ticks: {
                                color: '#3d5BA6'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(152, 197, 237, 0.3)'
                            },
                            ticks: {
                                color: '#3d5BA6'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function getMetricLabel(metricType) {
            switch(metricType) {
                case 'calls': return 'Total Calls';
                case 'success': return 'Successful Calls';
                case 'declines': return 'Declined Calls';
                case 'rate': return 'Success Rate (%)';
                default: return 'Total Calls';
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
